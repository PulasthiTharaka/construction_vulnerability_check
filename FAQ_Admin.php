<?php 
// Include the database connection
include_once("dbconnect.php");

if(isset($_GET['delete_id'])){
    // Get the ID of the data from the URL
    $id = $_GET['delete_id'];
    // Delete the row from the table using prepared statement
    $stmt = mysqli_prepare($mysqli, "DELETE FROM faq WHERE id = ?");
    if ($stmt) {
        mysqli_stmt_bind_param($stmt, "i", $id);
        if (mysqli_stmt_execute($stmt)) {
            header("Location: FAQ_Admin.php");
        } else {
            echo "Error: " . mysqli_error($mysqli);
        }
        mysqli_stmt_close($stmt);
    } else {
        echo "Error: " . mysqli_error($mysqli);
    }
}

if(isset($_GET['edit_id'])){
    $id = $_GET['edit_id'];
    // Select data associated with this particular ID
    $stmt = mysqli_prepare($mysqli, "SELECT * FROM faq WHERE id = ?");
    if ($stmt) {
        mysqli_stmt_bind_param($stmt, "i", $id);
        if (mysqli_stmt_execute($stmt)) {
            $result = mysqli_stmt_get_result($stmt);
            $res = mysqli_fetch_array($result);
            $name = $res['name'];
            $email = $res['email'];
            $question = $res['question'];
            $answer = $res['answer'];
        } else {
            echo "Error: " . mysqli_error($mysqli);
        }
        mysqli_stmt_close($stmt);
    } else {
        echo "Error: " . mysqli_error($mysqli);
    }
}

if(isset($_POST['update'])) {    
    $id = $_POST['id'];
    $answer = $_POST['answer'];
    // Update the table using a prepared statement
    $stmt = mysqli_prepare($mysqli, "UPDATE faq SET answer = ? WHERE id = ?");
    if ($stmt) {
        mysqli_stmt_bind_param($stmt, "si", $answer, $id);
        if (mysqli_stmt_execute($stmt)) {
            // Answer updated successfully
        } else {
            echo "Error: " . mysqli_error($mysqli);
        }
        mysqli_stmt_close($stmt);
    } else {
        echo "Error: " . mysqli_error($mysqli);
    }
}

if(isset($_GET['on_id'])) {    
    $id = $_GET['on_id'];
    // Update the table using a prepared statement
    $stmt = mysqli_prepare($mysqli, "UPDATE faq SET view_status = 1 WHERE id = ?");
    if ($stmt) {
        mysqli_stmt_bind_param($stmt, "i", $id);
        if (mysqli_stmt_execute($stmt)) {
            // View status updated to 1
        } else {
            echo "Error: " . mysqli_error($mysqli);
        }
        mysqli_stmt_close($stmt);
    } else {
        echo "Error: " . mysqli_error($mysqli);
    }
}

if(isset($_GET['off_id'])) {    
    $id = $_GET['off_id'];
    // Update the table using a prepared statement
    $stmt = mysqli_prepare($mysqli, "UPDATE faq SET view_status = 0 WHERE id = ?");
    if ($stmt) {
        mysqli_stmt_bind_param($stmt, "i", $id);
        if (mysqli_stmt_execute($stmt)) {
            // View status updated to 0
        } else {
            echo "Error: " . mysqli_error($mysqli);
        }
        mysqli_stmt_close($stmt);
    } else {
        echo "Error: " . mysqli_error($mysqli);
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>FAQ Admin</title>
    <link rel="stylesheet" href="css/faq_admin.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300&display=swap" rel="stylesheet">
    <script src="js/AboutUs.js"></script>
</head>
<body>
    <!--Header Section with Navigation Bar-->
    <header>
        <div class="logo">
            <img class="logo1" src="img/nav1.jpg">
            <label>EverGreen Constructions</label>
        </div>
        <nav>
            <a href="Homepage.html">Home</a>
            <a href="Services.html">Services</a>
            <a href="Awards.html">Awards</a>
            <a href="News&Media.html">News & Media</a>
            <a href="Offers.html">Offers</a>
            <a href="AboutUs.html">About Us</a>
            <a href="ContactUs.html">Contact Us</a>
            <a href="FAQ.php">FAQ</a>
        </nav>
    </header>
    <!--End of Header Section with Navigation Bar-->
    <div class="content-area center">
        <table>
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Email</th>
                <th>Question</th>
                <th>Answer</th>
                <th style="width:160px">Action</th>
            </tr>
            <?php
$result = mysqli_query($mysqli, "SELECT * FROM faq");
if (!$result) {
    die("Database query failed: " . mysqli_error($mysqli)); // Handle the error gracefully
}

while ($row = mysqli_fetch_array($result)) {
    $id = $row['id'];
    $name = $row['name'];
    $email = $row['email'];
    $question = $row['question'];
    $answer = $row['answer'];
    $viewStatus = $row['view_status'];

    echo "<tr>";
    echo "<td>$id</td>";
    echo "<td>$name</td>";
    echo "<td>$email</td>";
    echo "<td>$question</td>";
    echo "<td>$answer</td>";

    if ($answer != null) {
        if ($viewStatus == 0) {
            echo "<td><a href='FAQ_Admin.php?on_id=$id'><button class='btn red' style='margin-bottom: 20px;'><i class='fa fa-toggle-off'></i></button></a></td>";
        } else {
            echo "<td><a href='FAQ_Admin.php?off_id=$id'><button class='btn green' style='margin-bottom: 20px;'><i class='fa fa-toggle-on'></i></button></a></td>";
        }
    }

    echo "<td>";
    echo "<a href='FAQ_Admin.php?edit_id=$id'><button class='btn orange' style='margin-bottom: 20px;'><i class='fa fa-pencil'></i></button></a>";
    echo "<a href='FAQ_Admin.php?delete_id=$id' onClick='return confirm(\"Are you sure you want to delete?\")'><button class='btn red' style='margin-bottom: 20px;'><i class='fa fa-times'></i></button></a>";
    echo "</td>";
    echo "</tr>";
}
?>

        </table><br>

<?php
    if (isset($_GET['edit_id'])) {
    $id = $_GET['edit_id'];

    // Select data associated with this particular ID
    $stmt = mysqli_prepare($mysqli, "SELECT * FROM faq WHERE id = ?");
    if ($stmt) {
        mysqli_stmt_bind_param($stmt, "i", $id);
        if (mysqli_stmt_execute($stmt)) {
            $result = mysqli_stmt_get_result($stmt);
            $res = mysqli_fetch_array($result);

            $name = htmlspecialchars($res['name'], ENT_QUOTES, 'UTF-8');
            $email = htmlspecialchars($res['email'], ENT_QUOTES, 'UTF-8');
            $question = htmlspecialchars($res['question'], ENT_QUOTES, 'UTF-8');
            $answer = htmlspecialchars($res['answer'], ENT_QUOTES, 'UTF-8');
        } else {
            echo "Error: " . mysqli_error($mysqli);
        }
        mysqli_stmt_close($stmt);
    } else {
        echo "Error: " . mysqli_error($mysqli);
    }
}
?>
    </div>
    <!--Footer Section-->
    <footer class="footer-distributed">
        <div class="footer-left">
            <img src="img/nav1.jpg" style="width: 50px; height: 50px;"><br><br>
            <h3>EVERGREEN<span> CONSTRUCTION</span></h3>
            <p class="footer-links">
                <a href="Homepage.html">Home</a>
                |
                <a href="News&Media.html">News & Media</a>
                |
                <a href="AboutUs.html">About Us</a>
                |
                <a href="ContactUs.html">Contact Us</a>
                |
                <a href="Services.html">Services</a>
            </p>
            <p class="footer-company-name">Copyright &copy 2020. All rights reserved</p>
        </div>
        <div class="footer-center">
            <div>
                <br><br><br><br>
                <i class="fa fa-map-marker"></i>
                <p><span>
                    No 603,
                    New Kandy Rd,
                </span>
                    Malabe </p>
            </div>
            <div>
                <i class="fa fa-phone"></i>
                <p>011 649 2835</p>
            </div>
            <div>
                <i class="fa fa-envelope"></i>
                <p><a href="">eg-constructions@gmail.com</a></p>
            </div>
        </div>
        <div class="footer-right">
            <p class="footer-company-about">
                <br><br><br><br>
                <span>About the company</span>
                We Provide The Best Services As Your Choice
            </p>
            <div class="footer-icons">
                <a href="https://www.facebook.com/"><i class="fa fa-facebook"></i></a>
                <a href="https://twitter.com/"><i class="fa fa-twitter"></i></a>
                <a href="https://www.instagram.com/"><i class="fa fa-instagram"></i></a>
            </div>
        </div>
    </footer>
    <!--End of Footer Section-->
</body>
</html>
